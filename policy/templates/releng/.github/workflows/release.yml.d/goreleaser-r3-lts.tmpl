{{ define "goreleaser-r3-lts" }}
  goreleaser:
    runs-on: ubuntu-latest

    container: tykio/golang-cross:1.12

    outputs:
      tag: ${{ steps.targets.outputs.tag }}
      upload: ${{ steps.targets.outputs.upload }}
      pc: ${{ steps.targets.outputs.pc }}

    steps:
      - name: Fix private module deps
        env:
          TOKEN: '${{ secrets.REPO_TOKEN }}'
        run: >
          git config --global url."https://${TOKEN}@github.com".insteadOf "https://github.com"
      - name: Checkout of tyk
        uses: actions/checkout@v2
        with:
          fetch-depth: ${{ ! startsWith(github.ref, 'refs/tags') }}

      - uses: docker/setup-qemu-action@v1

      - uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        if: startsWith(github.ref, 'refs/tags')
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to Cloudsmith
        if: startsWith(github.ref, 'refs/tags')
        uses: docker/login-action@v1
        with:
          registry: docker.tyk.io
          username: ${{ secrets.CLOUDSMITH_USERNAME }}
          password: ${{ secrets.CLOUDSMITH_API_KEY }}

      - name: Unlock agent and set targets
        id: targets
        shell: bash
        env:
          NFPM_STD_PASSPHRASE: ${{ secrets.SIGNING_KEY_PASSPHRASE }}
          GPG_FINGERPRINT: 12B5D62C28F57592D1575BD51ED14C59E37DAC20
          PKG_SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          bin/unlock-agent.sh
          DOCKER_CFG_PATH="${DOCKER_CONFIG:-$HOME/.docker}/config.json"
          jq '. + {"experimental": "enabled"}' "$DOCKER_CFG_PATH" > c.json && mv c.json "$DOCKER_CFG_PATH" || rm c.json
          current_tag=${GITHUB_REF##*/}
          echo "::set-output name=tag::${current_tag}"
          if [[ $current_tag =~ .+-(qa|rc).* ]]; then
                  echo "::set-output name=upload::true"
                  echo "::set-output name=pc::tyk-gateway-unstable"
                  echo "::debug file=.goreleaser.yml::Pushing to unstable repos"
          # From https://semver.org/#is-there-a-suggested-regular-expression-regex-to-check-a-semver-string
          # If this is a public release, the tag is of the form vX.Y.Z where X, Y, Z ∈ ℤ
          elif [[ $current_tag =~ v(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*) ]]; then
                  echo "::set-output name=upload::true"
                  echo "::set-output name=pc::tyk-gateway-unstable"
                  echo "::debug file=.goreleaser.yml::Stable package -pushing to unstable repos- requires promotion"
          else
                  echo "::set-output name=upload::false"
                  echo "::debug file=.goreleaser.yml::No uploads"
          fi
      - name: Delete old release assets
        if: startsWith(github.ref, 'refs/tags')
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ github.token }}
          tag: ${{ github.ref }}
          fail-if-no-assets: false
          fail-if-no-release: false
          assets: |
            *.deb
            *.rpm
            *.tar.gz
            *.txt.sig
            *.txt
      - name: Fix vendor
        run: |
          export GOPATH=/go
          mkdir -p /go/src || true
          whereis go
          go mod tidy
          go mod vendor
          echo "Moving vendor"
          mv -f vendor/* $GOPATH/src
          rm -rf vendor
          mkdir -p /go/src/github.com/TykTechnologies/tyk
          cp -r ./* /go/src/github.com/TykTechnologies/tyk
          git checkout .
      - uses: goreleaser/goreleaser-action@v2
        with:
          version: latest
          args: release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CGO_ENABLED: 1
          GO111MODULE: off
          NFPM_STD_PASSPHRASE: ${{ secrets.SIGNING_KEY_PASSPHRASE }}
          NFPM_PAYG_PASSPHRASE: ${{ secrets.SIGNING_KEY_PASSPHRASE }}
          GPG_FINGERPRINT: 12B5D62C28F57592D1575BD51ED14C59E37DAC20
          PKG_SIGNING_KEY: ${{ secrets.SIGNING_KEY }}

      - uses: actions/upload-artifact@v2
        with:
          name: deb
          retention-days: 1
          path: |
            dist/*.deb
            !dist/*PAYG*.deb
      - uses: actions/upload-artifact@v2
        with:
          name: rpm
          retention-days: 1
          path: |
            dist/*.rpm
            !dist/*PAYG*.rpm
      - uses: actions/upload-artifact@v2
        with:
          name: payg
          retention-days: 1
          path: dist/*PAYG*
{{- end }}{{/* End of template definition. */}}
