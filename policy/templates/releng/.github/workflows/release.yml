# yamllint disable rule:line-length rule:truthy
---
name: Release

# Generated by: gromit policy

# Distribution channels covered by this workflow
# - Ubuntu and Debian
# - RHEL and AL
# - docker hub
# - devenv ECR
# - Cloudsmith

concurrency:
  group: {{`${{ github.workflow }}-${{ github.ref }}`}}
  cancel-in-progress: {{`${{ github.event_name == 'pull_request' }}`}}

on: 
{{- if ne .Name "portal" }}
  # Trigger release every monday at midnight for master CI images
  schedule:
    - cron: "0 0 * * 1"
{{- end }}
  pull_request:
  push:
    branches:
      - master
      - release-**
    tags:
      - 'v*'

env:
  GOPRIVATE: github.com/TykTechnologies
  VARIATION: prod-variation
  DOCKER_BUILD_SUMMARY: false
  DOCKER_BUILD_RECORD_UPLOAD: false
  # startsWith covers pull_request_target too
  BASE_REF: {{`${{startsWith(github.event_name, 'pull_request') && github.base_ref || github.ref_name}}`}}
  
jobs:
{{- template "goreleaser" . }}

{{- if not (empty .Branchvals.Tests) }}
{{- $dot := . }}
  {{ range $test := .Branchvals.Tests }}
  {{- template "auto-test" (dict "dot" $dot "test" $test "flow" "releng") }}
  {{ end }}
{{- end }} {{/* empty tests */}}

{{- template "aggregator" . }}

{{- template "smoke-tests" . }}

  sbom:
    needs: goreleaser
    uses: TykTechnologies/github-actions/.github/workflows/sbom.yaml@main
    secrets:
      DEPDASH_URL: ${{`{{ secrets.DEPDASH_URL }}`}}
      DEPDASH_KEY: ${{`{{ secrets.DEPDASH_KEY }}`}}
      ORG_GH_TOKEN: ${{`{{ secrets.ORG_GH_TOKEN }}`}}
{{- if eq .Name "tyk-analytics" }}
  report_logs:
    runs-on: ubuntu-latest
    needs: [test-controller-ui, test-controller-api, test-controller-distros, upgrade-deb, upgrade-rpm, release-tests]
    if: always()
    name: Report GH Logs on Failure
    permissions:
      actions: read
      contents: read
    steps:
      - name: Upload failed job logs
        uses: TykTechnologies/github-actions/.github/actions/gh-logs-analyser@main
        with:
          github_token: ${{`{{ secrets.GITHUB_TOKEN }}`}}
          gh_logs_analyser_token: ${{`{{ secrets.GH_LOGS_ANALYSER }}`}}
{{- end }}
{{/*
Local Variables:
mode: go-template
End:
*/}}
