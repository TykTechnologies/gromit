# `policy` is the root object for the policy and bundle commands. Any
# parent policy options provided here can be overridden by repo
# specific/branch specific options.

policy:
  # Owner component of Github reponame
  owner: TykTechnologies
  # deletedfiles are files that should not exist, usually the
  # detritutus of failed experiments or features than have been
  # superceded, they will be removed if policy sync encounters them
  deletedfiles:
    - .github/workflows/del-env.yml
    - .github/workflows/sync-automation.yml
    - .github/workflows/update-config-docs.yml
    - .github/workflows/pac.yml
    - .github/workflows/int-image.yml
    - .github/workflows/e2e_api_tests.yml
    - .github/workflows/api-tests.yml
    - repo-policy
    - bin/dist_push.sh
    - bin/dist_build.sh
    - bin/integration_build.sh
    - ci/Dockerfile.slim
    - ci/aws
    - ci/image
    - ci/auto
  # Groups collect repos that have some common feature
  groups:
    # cgo-services contains the metadata required to manage repos that
    # are services and require cgo
    cgo-services:
      # features act as flags whose presence/absence can be used to render
      # a common set of features across branch(es)
      # For eg: all regular builds now support el/7 by default,
      # but in order to build the pure go version of dashboard which can run on el7
      # we make use of the `el7-pgo-build` feature flag to write the template conditions
      # accordingly to it
      features:
        - releng
      # The build environment used for this repo. Right now, this value
      # is used for selecting the appropriate golang-cross image
      # used for building the binary, packages and docker images.
      buildenv: 1.23-bullseye
      # baseimage what the container images are based on. It needs to be a
      # debian compatible distro as the Dockerfile assumes apt-get
      baseimage: debian:trixie-slim
      # distrolessbaseimage is used for container images when the
      # distroless feature is set. base is appropriate for cgo
      # builds, static for pure go.
      distrolessbaseimage: base-debian12:nonroot
      # Repo specific policies start here->
      repos:
        # Repo specific policy for `tyk` starts here->
        tyk:
          distrolessbaseimage: base-debian12:latest
          # packagename is the historical name of the package. Builds
          # may produce artifacts named differently but the
          # directories and contents of the package use this name.
          packagename: tyk-gateway
          # Builds and corresponding packages. There is no static
          # compatibility check, the only way to know if the
          # combination of cgo, flags and archs work is to look at the
          # test results in the repo
          builds:
            # std builds are open access
            std:
              # passed to go build -flags
              flags:
                - -tags=goplugin
              # Description for the repo - this will be used as description for
              # deb/rpm packages, docker images etc.
              description: >-
                Tyk Open Source API Gateway written in Go, supporting REST, GraphQL, TCP and gRPC protocols
              # imagetitle goes into the OCI labels
              imagetitle: Tyk Gateway
              # The name for the deb/rpm packages generated by release workflow.
              buildpackagename: tyk-gateway
              # The packagecloud repo to test upgrades from
              upgraderepo: tyk-gateway
              # The packagecloud repo for package uploads
              pcrepo: tyk-gateway-unstable
              # The dockerhub image name for this repo. in the form of repo/image
              dhrepo: tykio/tyk-gateway
              # Cloudsmith image name for this repo.
              csrepo: docker.tyk.io/tyk-gateway/tyk-gateway
              # CI repo name, regsitry is inferred in release.yml
              cirepo: tyk
              # List of target architectures for cross compilation
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
                - go: arm64
                  deb: aarch64
                  docker: linux/arm64
                - go: s390x
                  deb: s390x
                  docker: linux/s390x
            fips:
              flags:
                - -tags=goplugin,fips,boringcrypto
              buildpackagename: tyk-gateway-fips
              pcrepo: tyk-ee-unstable
              description: >-
                Tyk Open Source API Gateway written in Go, supporting REST, GraphQL, TCP and gRPC protocols
                Built with boringssl
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
              env:
                - GOEXPERIMENT=boringcrypto
          # The name of the binary generated after the build.
          binary: tyk
          # `protected` specifies repo specific protected branches - this gets
          # appended to the common protected branches if any.
          # Ports exposed by the docker images built for this repo/
          exposeports: "8080"
          # Specifies whether this repo had to be built with cgo
          # enabled. This will also generate separate packages for
          # older glibc versions (el7 and non-el7 release workflows)
          cgo: true
          # The version that's used for upgrade tests. This version
          # will be installed first and will then be upgraded with the
          # recently generated packages. Make sure that this is a version
          # that has candidate packages for all our supported OSes and archs.
          upgradefromver: 3.0.8
          # The default config file used by the application.
          configfile: tyk.conf
          # The go package which contains the `VERSION` string for this REPO.
          versionpackage: github.com/TykTechnologies/tyk/internal/build
          # tests are the automated tests that should be run on the the
          # official images. These tests are usually required for PRs to
          # pass so be careful with names
          tests: [api]
          # Different branches could have different policy as older branches
          # could be on a different releaese workflow. To override any branch
          # policy for a specific branch, they could be specified here, under
          # the respective branches.
          # Branch specific policy for different branches starts here.->
          branches:
            master:
              builds:
                std:
                  flags:
                    - -trimpath
                # ee builds are enterprise 
                ee:
                  flags:
                    - -tags=goplugin,ee
                  description: >-
                    Tyk API Gateway Enterprise Edition written in Go, supporting REST, GraphQL, TCP and gRPC protocols
                  imagetitle: Tyk Gateway Enterprise Edition
                  buildpackagename: tyk-gateway-ee
                  pcrepo: tyk-ee-unstable
                  dhrepo: tykio/tyk-gateway-ee
                  cirepo: tyk-ee
                  archs:
                    - go: amd64
                      deb: amd64
                      docker: linux/amd64
                    - go: arm64
                      deb: aarch64
                      docker: linux/arm64
                    - go: s390x
                      deb: s390x
                      docker: linux/s390x
              features:
                - release-test
                - distroless
            release-5.3:
              buildenv: 1.23-bullseye
              features:
                - distroless
                - release-test
            release-5-lts:
              buildenv: 1.16
              features:
                - plugin-compiler-fix-vendor
                - python-support
            release-5.8:
              builds:
                ee:
                  flags:
                    - -tags=goplugin,ee
                  description: >-
                    Tyk API Gateway Enterprise Edition written in Go, supporting REST, GraphQL, TCP and gRPC protocols
                  imagetitle: Tyk Gateway Enterprise Edition
                  buildpackagename: tyk-gateway-ee
                  pcrepo: tyk-ee-unstable
                  dhrepo: tykio/tyk-gateway-ee
                  cirepo: tyk-ee
                  archs:
                    - go: amd64
                      deb: amd64
                      docker: linux/amd64
                    - go: arm64
                      deb: aarch64
                      docker: linux/arm64
                    - go: s390x
                      deb: s390x
                      docker: linux/s390x
              features:
                - release-test
                - distroless

        tyk-analytics:
          pcrepo: tyk-dashboard-unstable
          dhrepo: tykio/tyk-dashboard
          csrepo: docker.tyk.io/tyk-dashboard/tyk-dashboard
          exposeports: "3000 5000"
          packagename: tyk-dashboard
          binary: tyk-analytics
          buildpackagename: tyk-dashboard
          cgo: true
          upgradefromver: 3.0.9
          configfile: tyk_analytics.conf
          deletedfiles:
            - .github/workflows/release-tests-api.yml
            - .github/workflows/release-tests-ui.yml
          versionpackage: github.com/TykTechnologies/tyk-analytics/internal/build
          tests:
            - ui
            - api
          builds:
            std:
              description: >-
                Dashboard for the Tyk API Gateway
              imagetitle: Tyk Dashboard
              buildpackagename: tyk-dashboard
              pcrepo: tyk-dashboard-unstable
              upgraderepo: tyk-dashboard
              dhrepo: tykio/tyk-dashboard
              csrepo: docker.tyk.io/tyk-dashboard/tyk-dashboard
              cirepo: tyk-analytics
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
                - go: arm64
                  deb: aarch64
                  docker: linux/arm64
                - go: s390x
                  deb: s390x
                  docker: linux/s390x
            fips:
              flags:
                - -tags=fips,boringcrypto
              description: >-
                Dashboard for the Tyk API Gateway.
                This version is compiled with boringssl.
              buildpackagename: tyk-dashboard-fips
              pcrepo: tyk-ee-unstable
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
              env:
                - GOEXPERIMENT=boringcrypto
          branches:
            master:
              cgo: false
              features:
                - nightly-e2e
                - distroless
                - release-test
            release-5.3:
              buildenv: 1.23-bullseye
              features:
                - distroless
                - release-test
            release-5-lts:
              buildenv: 1.16
              features:
                - el7-pgo-build
            release-5.8:
              buildenv: 1.23-bullseye
              cgo: false
              features:
                - nightly-e2e
                - distroless
                - release-test

        portal:
          exposeports: 80
          packagename: portal
          binary: dev-portal
          buildpackagename: portal
          buildenv: 1.22-bullseye
          cgo: true
          upgradefromver: 1.0.0
          configfile: portal.conf
          versionpackage: github.com/TykTechnologies/portal/model/version
          features:
            - distroless
          builds: 
            std:
              buildpackagename: portal
              description: >-
                Developer portal for the Tyk API Gateway
              pcrepo: portal-unstable
              upgraderepo: portal
              dhrepo: tykio/portal
              cirepo: portal
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
                - go: arm64
                  deb: aarch64
                  docker: linux/arm64
                - go: s390x
                  deb: s390x
                  docker: linux/s390x
          branches:
            master:

    pgo-services:
      features:
        - releng
        - distroless
      buildenv: 1.22-bookworm
      baseimage: debian:trixie-slim
      distrolessbaseimage: static-debian12:nonroot
      repos:
        tyk-pump:
          packagename: tyk-pump
          exposeports: "80"
          binary: tyk-pump
          cgo: false
          upgradefromver: 1.6.0
          configfile: pump.conf
          versionpackage: github.com/TykTechnologies/tyk-pump/pumps
          tests: [api]
          builds:
            std:
              description: >-
                Tyk Analytics Pump to move analytics data from Redis to any supported back end (multiple back ends can be written to at once).
              imagetitle: Tyk Analytics Pump
              buildpackagename: tyk-pump
              upgraderepo: tyk-pump
              pcrepo: tyk-pump-unstable
              dhrepo: tykio/tyk-pump-docker-pub
              csrepo: docker.tyk.io/tyk-pump/tyk-pump
              cirepo: tyk-pump
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
                - go: arm64
                  deb: aarch64
                  docker: linux/arm64
                - go: s390x
                  deb: s390x
                  docker: linux/s390x
            fips:
              flags:
                - -tags=fips,boringcrypto
              buildpackagename: tyk-pump-fips
              pcrepo: tyk-ee-unstable
              description: >-
                Tyk Analytics Pump to move analytics data from Redis to any supported back end (multiple back ends can be written to at once).
                This version is compiled with boringssl.
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
              env:
                - GOEXPERIMENT=boringcrypto
          branches:
            master:

        tyk-identity-broker:
          exposeports: 80
          binary: tyk-identity-broker
          packagename: tyk-identity-broker
          cgo: false
          upgradefromver: 1.1.0
          configfile: tib.conf
          versionpackage: github.com/TykTechnologies/tyk-identity-broker/main
          builds: 
            std:
              description: >-
                Tyk Authentication Proxy for third-party login
              imagetitle: Tyk Identity Broker
              buildpackagename: tyk-identity-broker
              pcrepo: tyk-identity-broker-unstable
              upgraderepo: tyk-identity-broker
              dhrepo: tykio/tyk-identity-broker
              csrepo: docker.tyk.io/tyk-identity-broker/tyk-identity-broker
              cirepo: tyk-identity-broker
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
                - go: arm64
                  deb: aarch64
                  docker: linux/arm64
                - go: s390x
                  deb: s390x
                  docker: linux/s390x
          branches:
            master:

        tyk-sink:
          buildenv: 1.23-bullseye
          exposeports: 80
          binary: tyk-sink
          cgo: false
          packagename: tyk-sink
          upgradefromver: 1.8.2
          configfile: tyk_sink.conf
          versionpackage: github.com/TykTechnologies/tyk-sink/main
          tests: [api]
          builds: 
            std:
              description: >-
                Tyk RPC server backend (bridge)
              imagetitle: Multi Data Centre Bridge for Tyk Gateway and Dashboard
              buildpackagename: tyk-sink
              pcrepo: tyk-mdcb-unstable
              upgraderepo: tyk-mdcb-stable
              dhrepo: tykio/tyk-mdcb-docker
              cirepo: tyk-sink
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
                - go: arm64
                  deb: aarch64
                  docker: linux/arm64
                - go: s390x
                  deb: s390x
                  docker: linux/s390x
            fips:
              flags:
                - -tags=fips,boringcrypto
              buildpackagename: tyk-sink-fips
              pcrepo: tyk-ee-unstable
              description: >-
                Tyk RPC server backend (bridge)
                This version is compiled with boringssl.
              imagetitle: Multi Data Centre Bridge for Tyk Gateway and Dashboard (boringssl)
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
              env:
                - GOEXPERIMENT=boringcrypto
          branches:
            master:

        midsommar:
          buildenv: 1.22-bullseye
          exposeports: 80
          packagename: midsommar
          binary: midsommar
          cgo: false
          upgradefromver: 0.0.1
          configfile: midsommar.conf
          versionpackage: github.com/TykTechnologies/midsommar/main
          builds: 
            std:
              buildpackagename: midsommar
              description: >-
                Tyk AI Portal
              pcrepo: midsommar
              dhrepo: tykio/midsommar
              cirepo: midsommar
              archs:
                - go: amd64
                  deb: amd64
                  docker: linux/amd64
                - go: arm64
                  deb: aarch64
                  docker: linux/arm64
                - go: s390x
                  deb: s390x
                  docker: linux/s390x
          branches:
            main:

    # Quis qustodiet ipsos custodes?
    # A:
    test-square:
      repos:
        tyk-pro:
          owner: TykTechnologies
          deletedfiles:
            - .github/workflows/release-tests.yml
          description: >-
            Tyk automation repo environment for regression testing
          tests:
            - api
            - ui
          features:
            - test-square
          branches:
            main:

# pkgs is used by the pkgs subcommand to weed packagecloud. Unlike the
# policy key, you cannot override parameters from other levels.
# Precedence is exceptions > versioncutoff > agecutoff

# Quirks of x/mod/semver:
# - all versions string have a v prefix though the packages do not
# - vMAJOR is treated as vMAJOR.0.0
# - vMAJOR.MINOR is treated as vMAJOR.MINOR.0
pkgs:
  tyk-gateway:
    # notbackup determines if packages are downloaded before being deleted
    # It is inverted so that if it is omitted from some repo, it will failsafe to false
    notbackup: false
    # exceptions are those versions that should not be deleted from
    # packagecloud. These don't have to be semver. 
    exceptions:
      - v2.6.2
      - v2.9.3
      - v2.9.4
      - v2.9.4.1
      - v2.9.4.5
      - v2.9.4.3-1
      - v2.9.4.7
      - v2.8.3
      - v3.0.8 # used in upgrade tests
    # versions strictly older (semver) than versioncutoff will be removed. A
    # package version that is not semver will not be removed.
    versioncutoff: v3
  tyk-dashboard:
    notbackup: false
    exceptions:
      - v2.6.2
      - v2.9.3
      - v2.9.4
      - v2.9.4.1
      - v2.9.4.5
      - v2.9.4.3-1
      - v2.9.4.7
      - v2.8.3
      - v3.0.8 # used in upgrade tests
    versioncutoff: v3
  tyk-pump:
    notbackup: false
    exceptions:
      - v1.6.0 # used in upgrade tests
    versioncutoff: v1
  tyk-mdcb:
    notbackup: false
    exceptions:
      - v1.8.2 # used in upgrade tests
    versioncutoff: v1.7
  portal:
    notbackup: false
    exceptions:
      - v1.0.0
    versioncutoff: v1
  tyk-identity-broker:
    notbackup: false
    exceptions:
      - v1.1.0 # used in upgrade tests
    agecutoff: 26280h # 3y
  tyk-gateway-unstable:
    notbackup: true
    # packages uploaded before agecutoff will be removed
    agecutoff: 2160h # 90d
  tyk-dashboard-unstable:
    notbackup: true
    #agecutoff: 1440h # 60d
    agecutoff: 2160h # 90d
  tyk-pump-unstable:
    notbackup: true
    agecutoff: 2160h # 90d
  tyk-mdcb-unstable:
    agecutoff: 2160h # 90d
  portal-unstable:
    notbackup: true
    agecutoff: 2160h # 90d
  tyk-identity-broker-unstable:
    notbackup: true
    agecutoff: 2160h # 90d
  tyk-sync-unstable:
    notbackup: true
    agecutoff: 2160h # 90d
